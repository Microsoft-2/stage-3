services:
  # --- INFRAESTRUCTURA ---
  activemq:
    image: apache/activemq-classic:latest
    ports:
      - "8161:8161"
      - "61616:61616"
    networks:
      - search-net

  nginx:
    image: nginx:latest
    ports:
      - "80:80"
    volumes:
      - ./nginx_local.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - search-node
    networks:
      - search-net

  # --- APLICACIÃ“N ---
  crawler:
    build: .
    command: com.microsoft2.bigdata.search.apps.CrawlerNode
    environment:
      - BROKER_URL=tcp://activemq:61616
      - BOOK_START=1000
      - BOOK_END=2000
      - DATALAKE_PATH=/app/data
    volumes:
      - datalake_shared:/app/data
    restart: on-failure
    networks:
      - search-net

  indexer:
    build: .
    command: com.microsoft2.bigdata.search.apps.IndexerNode
    environment:
      - BROKER_URL=tcp://activemq:61616
      - DATALAKE_PATH=/app/data
    volumes:
      - datalake_shared:/app/data
    depends_on:
      - activemq
    networks:
      - search-net

  search-node:
    build: .
    command: com.microsoft2.bigdata.search.apps.SearchNode
    environment:
      - PORT=8080
    networks:
      - search-net

networks:
  search-net:
    driver: bridge

# Definimos el volumen globalmente
volumes:
  datalake_shared: