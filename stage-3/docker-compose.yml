services:
  # --- INFRASTRUCTURE ---
  activemq:
    image: apache/activemq-classic:latest
    ports:
      - "8161:8161"
      - "61616:61616"
    networks:
      - search-net

  nginx:
    image: nginx:latest
    ports:
      - "80:80"
    volumes:
      - ./nginx_local.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - search-node-1
      - search-node-2
      - search-node-3
      - search-node-4
      - search-node-5
      - search-node-6
    networks:
      - search-net

  # --- CRAWLERS (6 Nodes - Different Ranges) ---
  crawler-1:
    build: .
    command: com.microsoft2.bigdata.search.apps.CrawlerNode
    restart: on-failure
    environment:
      - BROKER_URL=tcp://activemq:61616
      - BOOK_START=1000
      - BOOK_END=2000
    volumes:
      - datalake_shared:/app/data
    networks:
      - search-net

  crawler-2:
    build: .
    command: com.microsoft2.bigdata.search.apps.CrawlerNode
    restart: on-failure
    environment:
      - BROKER_URL=tcp://activemq:61616
      - BOOK_START=2000
      - BOOK_END=3000
    volumes:
      - datalake_shared:/app/data
    networks:
      - search-net

  crawler-3:
    build: .
    command: com.microsoft2.bigdata.search.apps.CrawlerNode
    restart: on-failure
    environment:
      - BROKER_URL=tcp://activemq:61616
      - BOOK_START=3000
      - BOOK_END=4000
    volumes:
      - datalake_shared:/app/data
    networks:
      - search-net

  crawler-4:
    build: .
    command: com.microsoft2.bigdata.search.apps.CrawlerNode
    restart: on-failure
    environment:
      - BROKER_URL=tcp://activemq:61616
      - BOOK_START=4000
      - BOOK_END=5000
    volumes:
      - datalake_shared:/app/data
    networks:
      - search-net

  crawler-5:
    build: .
    command: com.microsoft2.bigdata.search.apps.CrawlerNode
    restart: on-failure
    environment:
      - BROKER_URL=tcp://activemq:61616
      - BOOK_START=5000
      - BOOK_END=6000
    volumes:
      - datalake_shared:/app/data
    networks:
      - search-net

  crawler-6:
    build: .
    command: com.microsoft2.bigdata.search.apps.CrawlerNode
    restart: on-failure
    environment:
      - BROKER_URL=tcp://activemq:61616
      - BOOK_START=6000
      - BOOK_END=7000
    volumes:
      - datalake_shared:/app/data
    networks:
      - search-net

  # --- INDEXERS (6 Nodes) ---
  indexer-1:
    build: .
    command: com.microsoft2.bigdata.search.apps.IndexerNode
    restart: on-failure
    environment:
      - BROKER_URL=tcp://activemq:61616
    volumes:
      - datalake_shared:/app/data
    depends_on:
      - activemq
    networks:
      - search-net

  indexer-2:
    build: .
    command: com.microsoft2.bigdata.search.apps.IndexerNode
    restart: on-failure
    environment:
      - BROKER_URL=tcp://activemq:61616
    volumes:
      - datalake_shared:/app/data
    depends_on:
      - activemq
    networks:
      - search-net

  indexer-3:
    build: .
    command: com.microsoft2.bigdata.search.apps.IndexerNode
    restart: on-failure
    environment:
      - BROKER_URL=tcp://activemq:61616
    volumes:
      - datalake_shared:/app/data
    depends_on:
      - activemq
    networks:
      - search-net

  indexer-4:
    build: .
    command: com.microsoft2.bigdata.search.apps.IndexerNode
    restart: on-failure
    environment:
      - BROKER_URL=tcp://activemq:61616
    volumes:
      - datalake_shared:/app/data
    depends_on:
      - activemq
    networks:
      - search-net

  indexer-5:
    build: .
    command: com.microsoft2.bigdata.search.apps.IndexerNode
    restart: on-failure
    environment:
      - BROKER_URL=tcp://activemq:61616
    volumes:
      - datalake_shared:/app/data
    depends_on:
      - activemq
    networks:
      - search-net

  indexer-6:
    build: .
    command: com.microsoft2.bigdata.search.apps.IndexerNode
    restart: on-failure
    environment:
      - BROKER_URL=tcp://activemq:61616
    volumes:
      - datalake_shared:/app/data
    depends_on:
      - activemq
    networks:
      - search-net

  # --- SEARCH NODES (6 Nodes) ---
  search-node-1:
    build: .
    command: com.microsoft2.bigdata.search.apps.SearchNode
    environment:
      - PORT=8080
    networks:
      - search-net

  search-node-2:
    build: .
    command: com.microsoft2.bigdata.search.apps.SearchNode
    environment:
      - PORT=8080
    networks:
      - search-net

  search-node-3:
    build: .
    command: com.microsoft2.bigdata.search.apps.SearchNode
    environment:
      - PORT=8080
    networks:
      - search-net

  search-node-4:
    build: .
    command: com.microsoft2.bigdata.search.apps.SearchNode
    environment:
      - PORT=8080
    networks:
      - search-net

  search-node-5:
    build: .
    command: com.microsoft2.bigdata.search.apps.SearchNode
    environment:
      - PORT=8080
    networks:
      - search-net

  search-node-6:
    build: .
    command: com.microsoft2.bigdata.search.apps.SearchNode
    environment:
      - PORT=8080
    networks:
      - search-net

networks:
  search-net:
    driver: bridge

volumes:
  datalake_shared:
